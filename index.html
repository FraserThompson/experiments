<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>schway.space</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
		<link rel="stylesheet" href="style.css">
	</head>
  	<body id="everything">
		<form onsubmit="return false;">
			<div class="container">
				<div class="row">
					<div class="twelve columns">
						<center><h1 class="wow">schway space</h1></center>
					</div>
				</div>
				<div class="row">
					<div class="six columns">
						<fieldset>
							<label><input type="radio" name="language" value="japanese" checked>Japanese</label>
							<label><input type="radio" name="language" value="russian"> Russian</label>
							<label><input type="radio" name="language" value="uk"> UK English</label>
							<label><input type="radio" name="language" value="indian"> Indian</label>
						</fieldset>
					</div>
					<div class="six columns">
						<fieldset>
							<label><input type="radio" name="language" value="chinese"> Chinese</label>
							<label><input type="radio" name="language" value="german"> German</label>
							<label><input type="radio" name="language" value="us"> US English</label>
							<label><input type="radio" name="language" value="polish"> Polish</label>
						</fieldset>
					</div>
				</div>
				<div class="row">
				    <div class="ten columns">
						<label for="rate">Rate</label>
						<input style="width:100%;" type="range" id="rate" step="0.1" max="2" min="0.1" oninput="updateRange(this.value);"/>
					</div>
					<div class="two columns">
						<output name="rangeOutput" id="rangeOutput">1</output>
					</div>
				</div>
				<div class="row">
				    <div class="ten columns">
						<label for="pitch">Pitch</label>
						<input style="width:100%;" type="range" id="pitch" step="0.1" max="2" min="0.1" oninput="updatePitch(this.value);"/>
					</div>
					<div class="two columns">
						<output name="pitchOutput" id="pitchOutput">1</output>
					</div>
				</div>
				<div class="row">
				    <div class="ten columns">
						<input style="width: 100%" maxlength="256" type="text" id="message" value="you used to call me on your cellphone"/>
					</div>
					<div class="two columns">
						<input type="submit" value="Talk" id="go" onclick="talk();"/>
					</div>
				</div>
				<div class="row">
					<div class="two columns">
						<input type="button" value="Generate link" id="link" onclick="generateLink();"/>
					</div>
					<div class="ten columns">
						<a id="linkOutput"></a>
					</div>
				</div>
				<div class="row" style="display: none;">
					<div class="ten columns">
						<button onclick="startRecognizing();">Listen to me</button>
					</div>
				</div>
			</div>
		</form>
		<pre id="result"></pre>
		<script>
			/* Init variables */
			var languages = {'japanese': [11, 'ja-JP'], 'russian': [16, 'ru-RU'], 'uk': [3, 'en-GB'], 'indian': [8, 'hi-IN'], 'chinese': [17, 'zh-CN'], 'polish': [14, 'pl-PL'], 'german': [1, 'de-DE'], 'us': [2, 'en-US']};
			var voices = [];
			var rangeOutput = document.getElementById('rangeOutput');
			var pitchOutput = document.getElementById('pitchOutput');
			var rate = document.getElementById('rate');
			var pitch = document.getElementById('pitch');
			var message = document.getElementById('message');
			var linkOutput = document.getElementById('linkOutput');
			var everything = document.getElementById('everything');
			var rootURL = "http://schway.space";
			var loading = true;

			function getQueryParams(qs) {
			    qs = qs.split('+').join(' ');

			    var params = {},
			        tokens,
			        re = /[?&]?([^=]+)=([^&]*)/g;

			    while (tokens = re.exec(qs)) {
			        params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
			    }

			    return params;
			}

			function startRecognizing() {
				var recognition = new webkitSpeechRecognition();
				recognition.continuous = true;
				recognition.interimResults = true;

				var result = document.getElementById('result');

				recognition.onresult = function(event) { 
				  console.log(event)
				}

				recognition.start();
			}

			function generateLink() {
				var link = rootURL + '?s=' + btoa(document.getElementById('message').value) + '&c=' + rate.value + '&h=' + pitch.value + '&w=' + languages[document.querySelector('input[name="language"]:checked').value];
				linkOutput.innerHTML = link;
				linkOutput.href = link;
			}

			function updateRange(val) {
		      rangeOutput.value=val; 
		    }

		    function updatePitch(val) {
		      pitchOutput.value=val; 
		    }

			function talk() {
				var msg = new SpeechSynthesisUtterance();
				var chosenLanguage = languages[document.querySelector('input[name="language"]:checked').value]; 
			    msg.voiceURI = 'native';
			    msg.volume = 1;
			    msg.rate = rate.value;
			    msg.pitch = pitch.value;
			    //msg.text = 'Hello and welcome to schway.space the best place on the internet to have a good time. How are you today. The time is ' + hours + ' ' + minutes + ' and it is ' + day;
			    msg.lang = chosenLanguage[1];
			    msg.voice = voices[chosenLanguage[0]]
				msg.text = message.value;
				speechSynthesis.speak(msg);
			}

			window.speechSynthesis.onvoiceschanged = function() {
				voices = window.speechSynthesis.getVoices();

				if (loading == true) {

					loading = false;

					/* Check if we have something to say */
					var queryParams = getQueryParams(document.location.search);
					if (queryParams.s) {
						var msg = new SpeechSynthesisUtterance();
						var chosenLanguage = queryParams.w.split(',');

					    msg.voiceURI = 'native';
					    msg.volume = 1;
					    msg.rate = queryParams.c;
					    msg.pitch = queryParams.h;
					    msg.lang = chosenLanguage[1];
					    msg.voice = voices[chosenLanguage[0]]
						msg.text = atob(queryParams.s);
						speechSynthesis.speak(msg);
					} else {
						everything.style.display = "initial";
					}

					console.log(voices);
				}
			};


		</script>
  	</body>
</html>
